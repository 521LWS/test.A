### 欢迎关注R语言数据分析指南

>最近有朋友需要绘制环状热图叠加多层注释，本节来通过一个例子来简单介绍一下如何实现，主要通过**ggtreeExtra**来实现，聚类分析使用**ape**包来进行更加适用于生物信息相关的数据。后续还可根据需要在此图上叠加更多的数据，整个过程仅参考。希望对各位观众老爷能有所帮助。**数据代码已经整合上传到2023VIP交流群**，加群的观众老爷可自行下载，有需要的朋友可关注文末介绍加入VIP交流群。

### 关于永久群内容的说明
>给予长期支持我们的忠实读者们一个特别待遇：凡是购买过小编2022年或2023年VIP会员文档的朋友们，**将自动获得2024年及以后的绘图资料和代码更新，无需额外付费。**目前这两年的会员文档已累记卖出1500+，质量方面各位无需担忧**。简要概括就是只要购买任意1年的会员内容，2024及后期公众号所更新的绘图文档均会在已经加入的会员群内分享。

### 加载R包
```r
library(tidyverse)
library(ggtree)
library(treeio)
library(ape)
library(magrittr)
library(ggnewscale)
library(ggtreeExtra)
library(RColorBrewer)
```
### 数据清洗
```r
# select(-Group)的作用是从数据中去除"Group"这一列
data <- read_tsv("data.xls") %>% 
  select(-Group) %>% 
  # 按照"id"和"Phylum"（门分类级别）分组
  # 对每个组内的所有数值型数据进行求和处理，忽略NA值
  group_by(id,Phylum) %>% 
  summarise(across(where(is.numeric), ~ sum(.x, na.rm=TRUE))) %>% 
  # 将数据从长格式转换为宽格式，以"Phylum"作为新列的名称，"Abundance"作为值
  pivot_wider(names_from = "Phylum",values_from = "Abundance")
```
### 构建表达量数据
```
# 将"data"数据框从宽格式转换为长格式，除"id"列外的所有列都会被转换
exp <- data %>% pivot_longer(-id)
```
### 构建聚类数据
```r
# 使用"data"数据框创建一个生物信息学树（系统发育树）
# 首先将"id"列设置为行名，然后计算距离矩阵，最后使用ape包的bionj函数构建树
tree <- data %>% column_to_rownames(var="id") %>% 
  dist() %>% ape::bionj()
```
### 构建分组数据
```r
# 读取"data.xls"文件中的"id"和"Group"列
# 添加一个新列"group"，所有值都设为"group"
group <- read_tsv("data.xls") %>% select(id,Group) %>% 
  mutate(group="group")
```
### 数据可视化
```r
# 使用ggtree创建树状图，设置分支长度、布局、线型等参数
# layout_fan用于设置扇形布局，angle=180表示旋转180度
plot <- ggtree(tree,branch.length = "none", layout = "circular",
       linetype = 1,size = 0.5, ladderize = T)+
  layout_fan(angle =180)+
  theme(plot.margin=margin(0,1,-7,0,"cm"))+
  # 添加树尖标签，设置偏移量、颜色等
  geom_tiplab(offset=10.5,show.legend=FALSE,size=2.8,
              color = "black",starstroke = 0)+
  # 添加基于"exp"数据的热图，设置瓷砖的宽度、偏移量等
  geom_fruit(data=exp,geom=geom_tile,
             mapping=aes(y=id,x=name,fill=value),
             pwidth=0.6,offset=0.02,
             axis.params=list(axis="x",text.angle=-90,text.size=2,hjust=0))+
  scale_fill_gradientn(colours = rev(RColorBrewer::brewer.pal(11,"RdBu")))+
  new_scale_fill()+
  # 添加基于"group"数据的热图，设置瓷砖的颜色、宽度等
  geom_fruit(data=group,geom=geom_tile,
             mapping=aes(y=id,x=group,fill=Group),color="white",
             pwidth=1,offset=0.4)+
  scale_fill_manual(values = c("#EDB749","#3CB2EC","#9C8D58"))

# 保存图形为PDF文件，设置文件名、尺寸和分辨率
ggsave(plot,file="heatmap.pdf",width=9.14,height=5.79,dpi=300)


![](https://files.mdnice.com/user/7338/30e36bb8-4513-40a5-b09b-aa249adc644a.png)

>此图只是叠加了两层注释信息，实际分析中有更多信息的还可以继续叠加；有需要学习数据可视化的朋友，欢迎到小编的**淘宝店铺** **R语言数据分析指南**下单购买，内容主要包括各种**高分论文的图表分析复现以及一些个性化图表的绘制**均包含数据+代码；

购买后微信发小编订单截图即邀请进新的会员交流群，无论购买那一年的会员文档都将获取**2024年及以后更新的绘图文档**，早买早享受，需要了解更多信息的朋友欢迎淘宝店铺交流咨询。


### 淘宝扫一扫

1

### 淘宝店铺(有需要欢迎关注)

1

### 关注下方公众号下回更新不迷路

1



